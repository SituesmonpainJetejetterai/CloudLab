#cloud-config

package_upgrade: true

packages:
  - jq
  - curl
  - vim

runcmd:
  # Install Salt Minion
  - mkdir -p /tmp/salt-minion/ && cd /tmp/salt-minion
  - curl -L https://bootstrap.saltstack.com -o install_salt.sh
  - sudo sh install_salt.sh
  - cd

write_files:
  - path: /etc/salt/minion
    content: |
      master: ${salt_master_dns}

# Install docker to be able to run containerd and cni-plugins
runcmd:
  - sudo yum install -y yum-utils
  - sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  - sudo yum install -y containerd.io
  # To-do: Install CNI plugins

runcmd:
  # Install Kubernetes
  # Set SELinux in permissive mode (effectively disabling it)
  - sudo setenforce 0
  - sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
  - sudo touch "/etc/yum.repos.d/kubernetes.repo"
  # This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo
  - |
    cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
    [kubernetes]
    name=Kubernetes
    baseurl=https://pkgs.k8s.io/core:/stable:/$(curl -sSL https://dl.k8s.io/release/stable.txt | sed 's/\(\.[0-9]*\)\.[0-9]*/\1/')/rpm/
    enabled=1
    gpgcheck=1
    gpgkey=https://pkgs.k8s.io/core:/stable:/$(curl -sSL https://dl.k8s.io/release/stable.txt | sed 's/\(\.[0-9]*\)\.[0-9]*/\1/')/rpm/repodata/repomd.xml.key
    exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
    EOF
  # Install kubelet, kubeadm and kubectl
  - sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
  - sudo systemctl enable --now kubelet

final_message: |
  cloud-init has finished
  version: $version
  timestamp: $timestamp
  datasource: $datasource
  uptime: $uptime
